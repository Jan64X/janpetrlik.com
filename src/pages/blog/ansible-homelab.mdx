---
layout: ../../layouts/BlogLayout.astro
title: "Building a 10,500-Line Ansible Homelab"
date: "2025-10-15"
description: "How I automated my entire 16-VM Proxmox homelab using Ansible, from bare metal to production services."
tags: ["Ansible", "Proxmox", "Infrastructure", "Automation"]
---

## Overview

Managing 16 virtual machines across different services manually is tedious and error-prone. This post walks through how I automated my entire homelab deployment using Ansible, resulting in a 10,500-line playbook that can rebuild the entire infrastructure from scratch.

## The Infrastructure

My homelab runs on a Dell PowerEdge R620 with:
- Dual Intel Xeon E5-2670 v2 (10 cores each, 20 cores/40 threads total)
- 256GB RAM
- Proxmox VE as the hypervisor
- 16 VMs running various services

## Why Ansible?

After manually configuring services multiple times and dealing with configuration drift, I needed infrastructure as code. Ansible was chosen because:

- **Agentless**: No need to install agents on managed nodes
- **YAML-based**: Easy to read and version control
- **Idempotent**: Can run playbooks multiple times safely
- **Large ecosystem**: Many community roles and modules available

## Project Structure

```
homelab-ansible/
├── inventory/
│   ├── hosts.yml
│   └── group_vars/
├── roles/
│   ├── proxmox/
│   ├── docker/
│   ├── nginx/
│   ├── monitoring/
│   └── ...
├── playbooks/
│   ├── site.yml
│   ├── bootstrap.yml
│   └── ...
└── templates/
```

## Key Components

### VM Provisioning

Automated Proxmox VM creation using the `community.general.proxmox_kvm` module:

```yaml
- name: Create VM
  community.general.proxmox_kvm:
    api_user: "{{ proxmox_user }}"
    api_password: "{{ proxmox_password }}"
    api_host: "{{ proxmox_host }}"
    name: "{{ vm_name }}"
    node: "{{ proxmox_node }}"
    cores: "{{ vm_cores }}"
    memory: "{{ vm_memory }}"
    net:
      net0: "virtio,bridge=vmbr0,tag={{ vlan_id }}"
    state: present
```

### Service Deployment

Each service has its own role with proper templating:

```yaml
- name: Deploy GitLab
  hosts: gitlab
  roles:
    - docker
    - gitlab
  vars:
    gitlab_external_url: "https://git.example.com"
    gitlab_smtp_enabled: true
```

### Configuration Templates

Using Jinja2 templates for configuration files:

```jinja
# nginx.conf.j2
upstream {{ service_name }} {
    server {{ backend_host }}:{{ backend_port }};
}

server {
    listen 443 ssl http2;
    server_name {{ domain }};
    
    ssl_certificate /etc/ssl/{{ domain }}.crt;
    ssl_certificate_key /etc/ssl/{{ domain }}.key;
    
    location / {
        proxy_pass http://{{ service_name }};
    }
}
```

## Monitoring Integration

Every service is automatically registered with Prometheus:

```yaml
- name: Configure Prometheus targets
  template:
    src: prometheus-targets.yml.j2
    dest: /etc/prometheus/targets/{{ inventory_hostname }}.yml
  delegate_to: monitoring
  notify: reload prometheus
```

## Lessons Learned

### 1. Start Small, Iterate

Don't try to automate everything at once. Start with one service, perfect it, then expand.

### 2. Use Roles Liberally

Breaking playbooks into reusable roles makes maintenance easier and enables composition.

### 3. Secrets Management

Used Ansible Vault for sensitive data:

```bash
ansible-vault encrypt group_vars/all/vault.yml
```

### 4. Idempotency is Key

Always test playbooks multiple times to ensure they're truly idempotent.

### 5. Documentation

Document variables and complex logic. Future you will thank present you.

## Results

- **Deployment time**: Full infrastructure rebuild in ~2 hours (was 2-3 days manual)
- **Consistency**: All VMs configured identically
- **Version control**: Every change tracked in Git
- **Disaster recovery**: Can rebuild from backups + playbook quickly

## Next Steps

Currently working on:
- CI/CD integration for automated testing
- Better secrets management with external vault
- More granular service monitoring
- Network automation (MikroTik configuration)

## Conclusion

Infrastructure as code transformed how I manage my homelab. The initial investment in writing Ansible playbooks paid off immediately in reliability and maintainability.

The complete playbook is available on [GitHub](https://github.com/jan64x).
